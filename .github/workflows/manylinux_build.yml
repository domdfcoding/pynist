# This file is managed by 'repo_helper'. Don't edit it directly.
---
name: Build manylinux Wheels

on:
  push:
    branches-ignore:
      - 'repo-helper-update'
      - 'pre-commit-ci-update-config'
      - 'imgbot'
    tags:
      - '*'
  pull_request:

permissions:
  actions: write
  issues: write
  contents: read

jobs:
  build:
    name: "manylinux${{ matrix.manylinux }}"
    runs-on: "ubuntu-20.04"

    strategy:
      fail-fast: False
      matrix:
        config:
          - {python-version: "3.6", tag: "cp36-cp36m"}
          - {python-version: "3.7", tag: "cp37-cp37m"}
          - {python-version: "3.8", tag: "cp38-cp38"}
          - {python-version: "3.9", tag: "cp39-cp39"}
          - {python-version: "3.10", tag: "cp310-cp310"}

    steps:
      - name: Checkout üõéÔ∏è
        uses: "actions/checkout@v2"

      - name: Set up Python üêç
        uses: actions/setup-python@v1
        with:
          python-version: 3.8

      - name: Install dependencies üîß
        run: |
          python -VV
          python -m site
          python -m pip install --upgrade pip setuptools wheel
          python -m pip install --upgrade twine tox

      - name: Build manylinux1 Python wheels üé°
        uses: RalfG/python-wheels-manylinux-build@v0.4.2-manylinux1_x86_64
        with:
          python-versions: '${{ matrix.config.tag }}'
#          build-requirements: 'cython numpy'
#          system-packages: 'lrzip-devel zlib-devel'
          package-path: ''
          pip-wheel-args: '--no-deps'

      - name: Build manylinux2010 Python wheels üé°
        uses: RalfG/python-wheels-manylinux-build@v0.4.2-manylinux2010_x86_64
        with:
          python-versions: '${{ matrix.config.tag }}'
          package-path: ''
          pip-wheel-args: '--no-deps'

      - name: Build manylinux2014 Python wheels üé°
        uses: RalfG/python-wheels-manylinux-build@v0.4.2-manylinux2014_x86_64
        with:
          python-versions: '${{ matrix.config.tag }}'
          package-path: ''
          pip-wheel-args: '--no-deps'

      - name: Upload Artifacts üöÄ
        uses: actions/upload-artifact@v2
        with:
          name: "wheels-${{ matrix.config.tag }}"
          path: wheelhouse/

      - name: "Run Tests"
        run: |
          for whl in wheelhouse/pyms_nist_search-*-${{ matrix.config.tag }}*-manylinux*.whl; do
            # Test tox with wheels
            python -m tox -r -e py${{ matrix.config.python-version }} --installpkg "$whl"
            # TODO: Upload coverage to coveralls
          done

      - uses: actions/upload-artifact@v3
        with:
          name: wheels
          path: wheelhouse/

      - name: Upload distribution üì¶ to PyPI
        if: startsWith(github.ref, 'refs/tags/')
        uses: pypa/gh-action-pypi-publish@master
        with:
          user: __token__
          password: ${{ secrets.PYPI_TOKEN }}
          packages_dir: wheelhouse/
          skip_existing: true
